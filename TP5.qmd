---
title: "TP5 - la semaine de 10 fevrier"
author: "Łukasz Mądry"
date: "2025-02-04"
output: html_document
---


```{r}
#| include: true
#| message: false
#| warning: false
require(patchwork)
require(httr)
require(glue)
require(ineq)
require(here)
require(skimr)
require(magrittr)
require(tidyverse)

old_theme <- theme_set(theme_minimal())
```

# Analyse exploratoire

https://r4ds.hadley.nz/eda

En cours, vous avez vu l'histogram. Voila l'exemple

```{r}
ggplot(diamonds, aes(x = carat)) +
  geom_histogram(binwidth = 0.5)
```

Essayons de voir de diamonds plus petits 

```{r}
smaller <- diamonds |> 
  filter(carat < 3)

ggplot(smaller, aes(x = carat)) +
  geom_histogram(binwidth = 0.01)
```

Il existe la possiblité que dans le tableau on pourra trouver les valeurs inhabituels, qui peuvent être un résultat d'erreur quelconque. 

```{r}
ggplot(diamonds, aes(x = y)) + 
  geom_histogram(binwidth = 0.5) +
  coord_cartesian(ylim = c(0, 50))
```

Ici on voit qu'il y a des diamonds dehors d'un groupe principal. On peut le sélectionner par le code suivant

```{r}
unusual <- diamonds |> 
  filter(y < 3 | y > 20) |> 
  select(price, x, y, z) |>
  arrange(y)
unusual
```

On peut faire d'histogram avec les valeurs NA

```{r}
nycflights13::flights |>   mutate(    cancelled = is.na(dep_time),    sched_hour = sched_dep_time %/% 100,    sched_min = sched_dep_time %% 100,    sched_dep_time = sched_hour + (sched_min / 60)  ) |>   ggplot(aes(x = sched_dep_time)) +   geom_freqpoly(aes(color = cancelled), binwidth = 1/4)
```

### Exercices 

Explorer la distribution des prix. Est-ce que vous trouvez quelque chose abnormal ou surprennant ? Pensez à la longeur d'intervalle et assurez-vous de bien essayer beaucoup de valeurs differentes.

Combien de diamonds sont à 0,99 carat ou 1 carat ? Pourquoi la difference ?

Recréer la graphe de frequence de `scheduled_dep_time` colore en fonction d'annulation de vols. 

### Les mesure de tendance centrales - la piege de moyenne et mediane

Ici on va comparer le moyenne et mediane sur quelques examples. On va charger un tableau de donnees de salaires francaises, telecharge de site web d'INSEE, ici https://www.insee.fr/fr/statistiques/7656152?sommaire=7656168#consulter 

```{r}
df <- read.csv("t201_down.csv", sep=";", header = TRUE)
head(df)
```

En cliquant sur "Dictionnaire" sur cet site, on peut se renseigner sur les noms de variables. Ce qui est important pour nous, c'est la variable $BRUT_EQTP qui signifie le salaire brut en equivalents temps plein.

```{r}
df %>% pull(BRUT_EQTP) %>% mean()
df %>% pull(BRUT_EQTP) %>% median()
```

On voit que la moyenne est beaucoup plus elevee que la mediane. 

```{r}
df %>% group_by(SEXE)
```

Par la description sur la site, il s'agit de donnees agrege, donc une ligne ne correspond pas forcement a une personne vraie, mais plutot l'ensemble des personnes. C'est pourquoi on a un troisieme sexe : "Ensemble". 

```{r}
df %>% group_by(SEXE) %>% summarise(moyenne = mean(BRUT_EQTP), mediane = median(BRUT_EQTP))
```

### Exercices

* Tracer un histogram ou `freqplot` par `ggplot`. D'abord un histogram pour toutes les categories confondus et ensuite deux histograms separes pour `H` et `F`. 

```{r}
df %>% ggplot(aes(x=BRUT_EQTP, fill=SEXE)) + geom_histogram()
```

* Modifier le code avec moyenne et mediane pour que ca fasse paraitre le salaire des gens en bas et en haut d'echelle salaire, par exemple les 10%, 20%, 30% les mieux et les moins renumeres. 
* Vu qu'il s'agit de donnees agreges, est-ce qu'une bonne idee de telecharger des autres donnees de site INSEE et d'utiliser `join` ? 

## Quand on peut s'attendre aux differences entre la mediane et moyenne ?

Normalement si l'ensemble de donnees est tres asymettrique, la mediane ne sera pas egale a moyenne. Pour l'illustrer, on va se servir de donnees tires de quelques distributions connus.

```{r}
lambda <- 1
data_exp <- rexp(1000, rate=1)

hist(data_exp, breaks = 50)
```

```{r}
sigma <- 2
data_norm <- rnorm(1000, mean = 0, sd=sigma)

hist(data_norm, breaks = 50)
```

```{r}
print('mean of normal variable')
mean(data_norm)

print('median of normal variable')
median(data_norm)

print('mean of exponential variable')
mean(data_exp)

print('median of exponential variable')
median(data_exp)
```
On voit que la variable normale a une moyenne a eu pres egale, mais ce n'est pas du tout un cas pour la variable exponentielle.

### Exercices

* Essayez de penser a une autre variable aleatoire que vous avez vue en cours de Proba qui est similaire en cette maniere a une variable exponentielle.
* Ecrire une code pour trouver les quantiles. Comparer-les avec les valeurs obtenus theoriquement.

* On va essayer de suivre une exemple bien plus extreme. Soit $X = (x_1, x_2, x_3, ..., x_N)$ avec $N$ tres grand une population des gens qui vont jouer une jeu d'hasard. Toute le monde commence avec le capital de 1, le jeu a toujours $k = 10$ etapes. Soit $C^i_k$ une capital de joeur $i$ apres $k$ etape. On fixe

\[ \mathbb{P}(C^i_k = 2 C^i_{k-1}) = 1/2 \quad \mathbb{P}(C^i_k = 0) = 1/2  \]

Autrement dit, avec probabilite $1/2$ on peut doubler notre capital ou tout perdre. Si on perd notre capital, on ne peut plus jouer parce que notre capital est egale a zero.

Questions:

** Ecrire une fonction qui va donner le resultat (aleatoire !) de jeu pour le capital de base 1.
** Appliquer cette fonction aux $N=10000$ joueurs (si c'est trop lente, vous pouvez faire $N=1000$)
** Combien de jouers finissent avec le capital plus grand que 10 ? Est-ce que consistent avec les prediction theoriques ? Calculer le moyenne, le mediane et les quantiles $1/10, 1/4, 3/4, 9/10$.
** Tracer une histogram du capital possede par la population. En moyenne, est-ce qu'on a plus ou moins du capital ? Diriez-vous que la population s'est appauvri ou s'est enrichi ?

# Prenoms des enfants (la semaine de 17 fevrier ou apres les vacances)

## Donnees francaises

Les donnes francais sont disponible sur la page web d'INSEE ici [INSEE](https://www.insee.fr/fr/accueil)  (French Governement Statistics Institute)

- [https://www.insee.fr/fr/statistiques/fichier/2540004/nat2021_csv.zip](https://www.insee.fr/fr/statistiques/fichier/2540004/nat2021_csv.zip)

Ces donnes ont ete consideres par des chercheurs en sciences sociales depuis des decennies. Les prenoms donnes peuvent faciliter l'analyse de beaucoup de phenomena sociaux, par exemple la suivi de religion.

Vous pouvez consulter par exemple [_L'archipel français_ by Jérome Fourquet, Le Seuil, 2019 ](https://www.seuil.com/ouvrage/l-archipel-francais-jerome-fourquet/9782021406023)

Lire [File documentation](https://www.insee.fr/fr/statistiques/2540004?sommaire=4767262#documentation)

```{r}
path_data <- 'DATA'
fname <- 'nat2021_csv.zip'
fpath <- here(path_data, fname)

if (!file.exists(fpath)){
  url <- "https://www.insee.fr/fr/statistiques/fichier/2540004/nat2021_csv.zip"
  download.file(url, fpath, mode="wb")
}   

df_fr <- readr::read_csv2(fpath)

# df_fr |> glimpse()
```

## US data 

Les donnes des Etats-Unis peuvent etre trouves

[Baby Names USA from 1910 to 2021 (SSA)](https://www.kaggle.com/datasets/donkea/ssa-names-1910-2021?resource=download)

Voir [https://www.ssa.gov/oact/babynames/background.html](https://www.ssa.gov/oact/babynames/background.html)


On peut aussi installer directement le package "babynames".


Full baby name data provided by the SSA. This includes all names with at least 5 uses.


```{r}
if (!require("babynames")){
  install.packages("babynames")
  stopifnot(require("babynames"), "Couldn't install and load package 'babynames'")
}
```

```{r}
?babynames
```

##  Tidy the French data 

On va changer les noms de colonnes.

```{r}
lkp <- list(year="annais",
  sex="sexe",
  name="preusuel",
  n="nombre")
```

```{r}
df_fr <- df_fr |>
  rename(!!!lkp) |>   # <1>
  mutate(country='fr') |>
  mutate(sex=as_factor(sex)) |>
  mutate(sex=fct_recode(sex, "M"="1", "F"="2")) |>
  mutate(sex=fct_relevel(sex, "F", "M")) |> 
  mutate(year=ifelse(year=="XXXX", NA, year)) |>
  mutate(year=as.integer(year)) 
  
df_fr  |>
  sample(5) |>
  glimpse()
```

1. `!!!` (bang-bang-bang) est rendu disponible par le package `rlang`. Ici, on l'utilise afin de faire *list unpacking* (si vous connaissez le dictionaire en Python, le but est similaire ici)

Telecharger 'Naissances totales par sexe' depuis URL `https://www.ined.fr/fichier/s_rubrique/168/t35.fr.xls` from [INED](https://www.ined.fr/).

```{r}
births_fr_path <- here(path_data, 't35.fr.xls')
births_fr_url <- 'https://www.ined.fr/fichier/s_rubrique/168/t35.fr.xls'

if (!file.exists(births_fr_path)) {
  download.file(births_fr_url, births_fr_path)
}
```

```{r}
births_fr <-  readxl::read_excel(births_fr_path, skip = 3)

births_fr <- births_fr[-1, ] 


births_fr |> 
  glimpse()
```

::: {.callout-tip}

Si vous avez des problemes avec le fichier excel, vous pouvez utiliser le fichier `csv` equivalent disponible ici [url](https://stephane-v-boucheron.fr/data/t35.fr.csv)

:::

```{r}
names(births_fr)[1] <- "year"
```

```{r}
births_fr <- births_fr |>
  mutate(year=as.integer(year)) |>
  drop_na()
```  

```{r}
births_fr |>
  ggplot() +
  aes(x=year, y=`Ensemble des nés vivants`) +
  geom_col() +
  labs(title="Births in France")
```

##  Tidy the American data


```{r}
babynames <- babynames |>
  mutate(country='us') |>
  mutate(sex=as_factor(sex))
  
babynames |>
  glimpse()
```



```{r}
births_us <- births

births_us  |> 
  ggplot() +
  aes(x=year, y=births) +
  geom_col() +
  labs(title="Births in USA")
```


```{r}

```


## Sex ratios 

::: {.callout-note}

### Question

Dans le tableau de donnees `df_fr` calculer le nombre totale de naissances par an. Calculer et creer un graphe de taux `hommes/femmes`.

:::


:::

::: {.callout-note}

### Question

Le comparer avec le taux donnes par le tableau venant d'INED.

:::

# Picturing concentration of babynames distributions

Chaque annee dans chaque payes, pour deux sexes, le comptage des noms definissent la distribution de proba discret. Cet distribution est normalement loin d'etre uniform et on veut quantifier le degre de ce distance d'uniformite.

On va utiliser les outils developpe pour l'econometrie. Sans perte en generalite, on suppose qu'on a la distribution sur l'ensemble fini $1, \ldots, n$ ou $n$ et le nombre des prenoms distincs donnees cette annee. 

On suppose que les frequences $p_1, p_2, \ldots, p_n$ sont donnees dans l'ordre croissant.

La fonction `Lorenz` ([Lorenz](https://en.wikipedia.org/wiki/Lorenz_curve) pas `Lorentz`) est l'application $[0, 1] \to [0, 1]$.

$$L(x) = \sum_{i=1}^{\lfloor nx \rfloor} p_i .$$
Notons qu'il s'agit d'une application constant sur morceaux.

::: {.callout-note}

### Question 

Calculer et faire une graphe de fonction Lorenz pour `sex`, `year` et `country`

:::

# Inequality indices 

La courbe de Lorenz decrit la distance entre la distribution uniform et celle qu'on etudie. Il s'agit d'un sujet tres richet et difficile a transmettre effectivement. Il est plus facile de concevoir la notion d'inegalite en s'appuyant sur un nombre (meme si souvent des gens ne le comprennent pas)

L'indice de [Gini](https://en.wikipedia.org/wiki/Gini_coefficient) est egale a deux fois d'aire entre $y=x$ et $y=L(x)$.

$$G = 2 \times \int_0^1 (x -L(x)) \mathrm{d}x$$

La formulae suivante nous permets de le calculer facilement.

$$G={\frac {2\sum _{i=1}^{n}i p_{i}}{n\sum _{i=1}^{n}p_{i}}}-{\frac {n+1}{n}}.$$


### Exercices

* Calculer l'indice de Gini pour `sex` et `year`.


* Revenir au tableau de donnees qu'on a considere au debut. Faire la meme chose pour les salaries.